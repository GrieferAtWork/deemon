#!/usr/bin/deemon
/* Copyright (c) 2018-2026 Griefer@Work                                       *
 *                                                                            *
 * This software is provided 'as-is', without any express or implied          *
 * warranty. In no event will the authors be held liable for any damages      *
 * arising from the use of this software.                                     *
 *                                                                            *
 * Permission is granted to anyone to use this software for any purpose,      *
 * including commercial applications, and to alter it and redistribute it     *
 * freely, subject to the following restrictions:                             *
 *                                                                            *
 * 1. The origin of this software must not be misrepresented; you must not    *
 *    claim that you wrote the original software. If you use this software    *
 *    in a product, an acknowledgement (see the following) in the product     *
 *    documentation is required:                                              *
 *    Portions Copyright (c) 2018-2026 Griefer@Work                           *
 * 2. Altered source versions must be plainly marked as such, and must not be *
 *    misrepresented as being the original software.                          *
 * 3. This notice may not be removed or altered from any source distribution. *
 */

import * from deemon;
import .common.test;
import rt;

local x = { {0, 1, 2}, {5, 7, 9}, {1, 10, 1} };
local flat = x.flatten;


test.assertSequence(flat, { 0, 1, 2, 5, 7, 9, 1, 10, 1 });
test.assertSequence(rt.SeqFlat(x), { 0, 1, 2, 5, 7, 9, 1, 10, 1 });
test.assertSequence(rt.SeqFlat(), {});
test.assertEqualsTyped(9, #flat);
test.assertEqualsTyped(0, flat[0]);
test.assertEqualsTyped(1, flat[1]);
test.assertEqualsTyped(2, flat[2]);
test.assertEqualsTyped(5, flat[3]);
test.assertSame(true, flat.any(e -> e == 0));
test.assertSame(false, flat.any(1, -1, e -> e == 0));
test.assertSame(true, flat.any(1, -1, e -> e == 9));
test.assertSame(true, flat.any(5, -1, e -> e == 9));
test.assertSame(false, flat.any(6, -1, e -> e == 9));
test.assertSame(false, flat.any(e -> e == 99));

test.assertEqualsTyped(0, flat.min());
test.assertEqualsTyped(10, flat.max());
test.assertEqualsTyped(0, flat.min(0, 4));
test.assertEqualsTyped(1, flat.min(1, 4));
test.assertEqualsTyped(2, flat.max(0, 3));
test.assertEqualsTyped(5, flat.max(0, 4));

test.assertEqualsTyped(10, flat.min(key: x -> -x));
test.assertEqualsTyped(0, flat.max(key: x -> -x));
test.assertEqualsTyped(2, flat.min(0, 3, key: x -> -x));
test.assertEqualsTyped(5, flat.min(0, 4, key: x -> -x));
test.assertEqualsTyped(0, flat.max(0, 4, key: x -> -x));
test.assertEqualsTyped(1, flat.max(1, 4, key: x -> -x));
test.assertNone({}.flatten.min());
test.assertNone({}.flatten.max());
test.assertNone({{}}.flatten.min());
test.assertNone({{}}.flatten.max());
test.assertNone({}.flatten.min(1, -1));
test.assertNone({}.flatten.max(1, -1));
test.assertNone({}.flatten.min(key: x -> "foo"));
test.assertNone({}.flatten.max(key: x -> "foo"));
test.assertNone({}.flatten.min(1, -1, key: x -> "foo"));
test.assertNone({}.flatten.max(1, -1, key: x -> "foo"));

test.assertSame(false, flat.all());
test.assertSame(false, flat.all(e -> e != 0));
test.assertSame(true, flat.all(1, -1));
test.assertSame(true, flat.all(1, -1, e -> e != 0));

test.assertEqualsTyped(0, flat.count(-1));
test.assertEqualsTyped(1, flat.count(0));
test.assertEqualsTyped(3, flat.count(1));
test.assertEqualsTyped(0, flat.count("-1", key: int.tostr));
test.assertEqualsTyped(1, flat.count("0", key: int.tostr));
test.assertEqualsTyped(3, flat.count("1", key: int.tostr));
test.assertEqualsTyped(0, flat.count(-1, 2, -1));
test.assertEqualsTyped(0, flat.count(0, 2, -1));
test.assertEqualsTyped(2, flat.count(1, 2, -1));
test.assertEqualsTyped(0, flat.count("-1", 2, -1, key: int.tostr));
test.assertEqualsTyped(0, flat.count("0", 2, -1, key: int.tostr));
test.assertEqualsTyped(2, flat.count("1", 2, -1, key: int.tostr));

test.assertEqualsTyped(-1, flat.find(-1));
test.assertEqualsTyped(0, flat.find(0));
test.assertEqualsTyped(1, flat.find(1));
test.assertEqualsTyped(8, flat.rfind(1));
test.assertEqualsTyped(-1, flat.find("-1", key: int.tostr));
test.assertEqualsTyped(0, flat.find("0", key: int.tostr));
test.assertEqualsTyped(1, flat.find("1", key: int.tostr));
test.assertEqualsTyped(8, flat.rfind("1", key: int.tostr));
test.assertEqualsTyped(-1, flat.find(-1, 2, -1));
test.assertEqualsTyped(-1, flat.find(0, 2, -1));
test.assertEqualsTyped(6, flat.find(1, 2, -1));
test.assertEqualsTyped(-1, flat.find("-1", 2, -1, key: int.tostr));
test.assertEqualsTyped(-1, flat.find("0", 2, -1, key: int.tostr));
test.assertEqualsTyped(6, flat.find("1", 2, -1, key: int.tostr));
test.assertEqualsTyped(8, flat.rfind("1", 2, -1, key: int.tostr));

test.assertSame(false, flat.contains(-1));
test.assertSame(true,  flat.contains(0));
test.assertSame(true,  flat.contains(1));
test.assertSame(false, flat.contains("-1", key: int.tostr));
test.assertSame(true,  flat.contains("0", key: int.tostr));
test.assertSame(true,  flat.contains("1", key: int.tostr));
test.assertSame(false, flat.contains(-1, 2, -1));
test.assertSame(false, flat.contains(0, 2, -1));
test.assertSame(true,  flat.contains(1, 2, -1));
test.assertSame(false, flat.contains("-1", 2, -1, key: int.tostr));
test.assertSame(false, flat.contains("0", 2, -1, key: int.tostr));
test.assertSame(true,  flat.contains("1", 2, -1, key: int.tostr));

test.assertSequence({ 10, 20, 30 }.map(e -> (e, e + 1)).flatten, { 10, 11, 20, 21, 30, 31 });

test.assertSame(true, { {true}, {}, {1, "foo"} }.flatten.all());
test.assertSame(true, { {true}, {}, {1, "foo"} }.flatten.all(e -> e !== false));
test.assertSame(false, { {true}, {}, {1, "foo", false} }.flatten.all(1, -1));
test.assertSame(false, { {true}, {}, {1, "foo", false} }.flatten.all(1, -1, e -> e !== false));


test.assertSame(false, { {0}, {}, {false, ""} }.flatten.any());
test.assertSame(true,  { {0}, {}, {true, ""} }.flatten.any());
test.assertSame(true,  { {0}, {}, {true, ""} }.flatten.any(1, -1));
test.assertSame(true,  { {1}, {}, {false, ""} }.flatten.any());
test.assertSame(false, { {1}, {}, {false, ""} }.flatten.any(1, -1));
test.assertSame(true,  { {0}, {}, {false, "hi"} }.flatten.any());

test.assertSame(false, { {0,0,true}, {true,1}, {}, {1} }.flatten.parity());
test.assertSame(true,  { {0,0,true}, {true,1}, {}, {0} }.flatten.parity());
test.assertSame(false, { {0,0,true}, {true,1}, {}, {1} }.flatten.parity(1, -1));
test.assertSame(true,  { {0,0,true}, {true,1}, {}, {0} }.flatten.parity(1, -1));
test.assertSame(true,  { {0,0,true}, {true,1}, {}, {1} }.flatten.parity(3, -1));
test.assertSame(false, { {0,0,true}, {true,1}, {}, {0} }.flatten.parity(3, -1));
test.assertSame(false, { {0,0,true}, {true, 1}, {}, {1} }.flatten.parity(key: e -> e === true));
test.assertSame(true,  { {0,0,true}, {false,1}, {}, {1} }.flatten.parity(key: e -> e === true));
test.assertSame(false, { {0,0,true}, {true, 1}, {}, {1} }.flatten.parity(1, -1, key: e -> e === true));
test.assertSame(true,  { {0,0,true}, {false,1}, {}, {1} }.flatten.parity(1, -1, key: e -> e === true));
test.assertSame(true,  { {0,0,true}, {true, 1}, {}, {1} }.flatten.parity(3, -1, key: e -> e === true));
test.assertSame(false, { {0,0,true}, {false,1}, {}, {1} }.flatten.parity(3, -1, key: e -> e === true));

for (local useInsertAll: {false, true}) {
	local a = [10, 20, 30];
	local b = [40, 50, 60];
	local c = {a,b}.flatten;

	function doInsert(i, v) {
		if (useInsertAll) {
			c.insertall(i, {v});
		} else {
			c.insert(i, v);
		}
	}

	test.assertSequence(c, {10,20,30,40,50,60});

	c.erase(2, 2);
	test.assertSequence(c, {10,20,50,60});
	test.assertSequence(a, {10,20});
	test.assertSequence(b, {50,60});

	doInsert(0, "hi");
	test.assertSequence(c, {"hi",10,20,50,60});
	test.assertSequence(a, {"hi",10,20});

	doInsert(3, "there");
	test.assertSequence(c, {"hi",10,20,"there",50,60});
	test.assertSequence(a, {"hi",10,20,"there"});

	doInsert(5, "second");
	test.assertSequence(c, {"hi",10,20,"there",50,"second",60});
	test.assertSequence(a, {"hi",10,20,"there"});
	test.assertSequence(b, {50,"second",60});

	doInsert(99999, "tail");
	test.assertSequence(c, {"hi",10,20,"there",50,"second",60,"tail"});
	test.assertSequence(b, {50,"second",60,"tail"});

	c.clear();
	test.assertSequence(c, {});
	test.assertSequence(a, {});
	test.assertSequence(b, {});

	c.pushfront("first");
	test.assertSequence(c, {"first"});
	test.assertSequence(a, {"first"});
	test.assertSequence(b, {});

	if (useInsertAll) {
		c.extend({"last"});
	} else {
		c.append("last");
	}
	test.assertSequence(c, {"first", "last"});
	test.assertSequence(a, {"first"});
	test.assertSequence(b, {"last"});
}
